<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil | Grafico</title>
    <script src="./js/funcoes.js"></script>
    <!-- Linkando O  CSS da tela de dashboard (grafico)-->
    <link rel="stylesheet" href="./css/estilo_Tela_Do_Grafico.css">

    <!-- Linkando o chart.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- linkando os icones-->
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="shortcut icon" href="./assets/img/favicon-32x32.png" type="image/x-icon" />

    <script src="./dist/gauge.min.js"></script>

</head>

<body>

    <!-- Div container do grafico e da navegação -->
    <div class="containerGrafico">

        <!-- Div que contem a parte de navegação (parte verde do menu)-->
        <div class="navegacao">
            <ul>
                <li>
                    <!-- Foto De Perfil do USUARIO e o NOME do mesmo -->
                    <div class="fotoDePerfil">
                        <a href="#">

                            <!-- imagem do ICONE DA FOTO DE PERFIL-->
                            <span class="icone"><i class="uil uil-user"></i> </span>
                            <span class="titulo"><span id="b_usuario">usuário</span></span>

                        </a>
                    </div>
                </li>

                <li>
                    <a href="./tela_Inicial_Do_Grafico.html">

                        <!-- Imagem do ICONE DO GRAFICO-->
                        <span class="icone"> <i class="uil uil-home"></i> </span>
                        <span class="titulo"> Início </span>

                    </a>
                </li>
                <li onclick="Adicionar()" id="adicionar2">
                    <a href="#">

                        <!--Imagem do ICONE DE ADICIONAR -->
                        <span class="icone"> <i class="uil uil-plus"></i> </span>
                        <span class="titulo"> Adicionar</span>
                        <span class="icone2"><i class="uil uil-angle-down"></i></span>

                    </a>
                </li>
                <div class="adicionar" id="adicionar3">

                    <li>
                        <a href="./cadastro_armazem.html">

                            <!--Imagem do ICONE DE ADICIONAR -->
                            <span class="icone"> <i class="uil uil-estate"></i> </span>
                            <span class="titulo"> Adicionar Armazem</span>
                        </a>
                    </li>
                    <li>
                        <a href="./cadastro_empresa.html">

                            <!--Imagem do ICONE DE ADICIONAR -->
                            <span class="icone"> <i class="uil uil-building"></i></span>
                            <span class="titulo"> Adicionar Empresa</span>

                        </a>
                    </li>
                    <li>
                        <a href="./cadastro_funcionario.html">

                            <!--Imagem do ICONE DE ADICIONAR -->
                            <span class="icone"> <i class="uil uil-user-plus"></i> </span>
                            <span class="titulo"> Adicionar Responsável</span>

                        </a>
                    </li>
                </div>
                <li>
                    <a href="./configuracoes.html">

                        <!-- Imagem do ICONE DE CONFIGURAÇÕES -->
                        <span class="icone" onclick="grafico()"><i class="uil uil-cog"></i></span>
                        <span class="titulo"> Configurações</span>

                    </a>
                </li>
                <li>
                    <a href="http://suporteMelvs.auvo.com.br">

                        <!-- Imagem do ICONE DE SUPORTE -->
                        <span class="icone"><i class="uil uil-comment-question"></i>
                        </span>
                        <span class="titulo"> Suporte</span>

                    </a>
                </li>
                <li>
                    <a href="#" class="Modo" onclick="ModoClaro()">

                        <!-- Dark Mode -->
                        <span class="icone"><i class="uil uil-moon"></i> </span>
                        <span id="ModoEscuro" class="Modo"> Modo Escuro </span>

                    </a>
                </li>
                <li>
                    <a href="./index.html">

                        <!-- Botão de Sair  -->
                        <span class="icone"><i class="uil uil-signout"></i> </span>
                        <span class="titulo"> Sair </span>

                    </a>
                </li>
            </ul>
        </div>
    </div>
</body>

<!-- **************************************************************************************** -->

<!--Menu-->

<div class="menu">

    <!-- Parte de Cima que contem A logo de Melvs e O botão de ocutar o menu-->
    <div class="barra-de-cima">

        <!-- Div Que tem o icone de Menu-->
        <div class="toggle">

            <!-- Imagem do ICONE DE MENU -->
            <i class="uil uil-list-ul"></i>

        </div>

        <!-- Div que contem A LOGO DA MELVIS -->
        <div>
            <!-- Imagem da logo da MELVS VERDE -->
            <img src="./assets/img/melvsLogo.png" onclick="grafico()" class="logo">

        </div>
        <div>

        </div>
    </div>


    <div class="container-conteudo">
        <div class="conteudo-esquerda">
            <div class="container-gauge">
                <div class="gauge-temperatura">
                    <canvas id='gauge-temperatura'></canvas>
                    <span>Temperatura: <b id="b_temperatura"></b></span>
                </div>
                <div class="gauge-umidade">
                    <canvas id='gauge-umidade'></canvas>
                    <span>Umidade: <b id="b_umidade"></b></span>
                </div>
                <div class="contador">
                    <h2>Quantidade de vezes que sairam do ideal:</h2>
                    <span>Temperatura:  <b><span id="span_temperatura">X</span></b> vezes</span>
                    <span>Umidade: <b><span id="span_umidade">X</span></b> vezes</span>
                </div>

            </div>
            <div class="grafico-linha">
                <canvas id="myChartCanvas"></canvas>
            </div>
        </div>
        <div class="conteudo-direita">
            <div class="grafico-mes">
                <h2>Média mensal</h2>
                <canvas id="grafico-mes" height="230%"></canvas>
            </div>
            <div class="grafico-ano">
                <h2>Média anual</h2>
                <canvas id="grafico-ano" height="230%"></canvas>
            </div>
        </div>
    </div>

</div>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    const labels = [
        '00h', '01h', '02h', '03h', '04h', '05h', '06h', '07h', '08h', '09h', '10h', '11h', '12h', '13h', '14h', '15h', '16h', '17h', '18h', '19h', '20h', '21h', '22h', '23h'
    ];

    const data = {
        labels: labels,
        datasets: [{
            label: 'Temperatura',
            backgroundColor: 'rgba(240,0,0)',
            borderColor: 'rgba(239,203,198,1)',
            tension: 0.3,
            data: [20, 21, 19, 19, 18, 18.5, 18, 19, 20, 19, 21, 23, 25, 26, 24, 25, 23, 22, 22, 20, 19, 20, 18, 19],
        }, {
            label: 'Umidade',
            backgroundColor: 'rgba(0,0,240)',
            borderColor: 'rgba(168,217,254,1)',
            tension: 0.3,
            data: [15, 15, 14, 15, 16, 15, 15, 14, 15, 16, 17, 18, 18, 17, 18, 19, 19, 19, 18, 18, 18, 15, 15, 15],
        }
        ]
    };
    Chart.defaults.color = "#054A29";
    Chart.defaults.font.size = 12;
    const config = {
        type: 'line',
        data: data,
        options: {}
    };
    const myChart = new Chart(
        document.getElementById('grafico_linha'),
        config
    );

    const semanas_mes = [
        'Semana 1', 'Semana 2', 'Semana 3', 'Semana 4',
    ];
    const temperatura_umidade_mes = {
        labels: semanas_mes,
        datasets: [{
            label: 'Temperatura Média',
            backgroundColor: 'rgba(247, 45, 45)',
            borderColor: 'rgba(247, 45, 45)',
            data: [15, 13, 13.5, 14],
        }, {
            label: 'Umidade Média',
            backgroundColor: 'rgba(25, 25, 251)',
            borderColor: 'rgba(25, 25, 251)',
            data: [11, 12, 12.7, 11],
        }
        ]
    };
    const config2 = {
        type: 'bar',
        data: temperatura_umidade_mes,
        options: {}
    };
    const myChart1 = new Chart(
        document.getElementById('grafico-mes'),
        config2
    );

    const meses_ano = [
        'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez',
    ];
    const temperatura_umidade_ano = {
        labels: meses_ano,
        datasets: [{
            label: 'Temperatura Média',
            backgroundColor: 'rgba(247, 45, 45)',
            borderColor: 'rgba(239,203,198,1)',
            tension: 0.5,
            data: [9, 12, 11, 13, 15, 8, 10, 12, 9, 13, 14, 11],
        }, {
            label: 'Umidade Média',
            backgroundColor: 'rgba(25, 25, 251)',
            borderColor: 'rgba(198, 203, 239,1)',
            tension: 0.5,
            data: [10, 8, 9, 11, 9, 13, 15, 13, 11, 10, 8, 10],

        }
        ]
    };
    const config3 = {
        type: 'line',
        data: temperatura_umidade_ano,
        options: {}
    };
    const myChart2 = new Chart(
        document.getElementById('grafico-ano'),
        config3
    );
</script>

<script>
    //deixar o menu toggle 
    let toggle = document.querySelector('.toggle');
    let navegacao = document.querySelector('.navegacao');
    let menu = document.querySelector('.menu');

    //Criando a função para quando clicar ativar e desativar
    toggle.onclick = function () {
        navegacao.classList.toggle('ativar');
        menu.classList.toggle('ativar');
    }
    navegacao.classList.toggle('ativar');
    menu.classList.toggle('ativar');
</script>

<!-- MODO ESCURO  MODO ESCURO  MODO ESCURO  MODO ESCURO  MODO ESCURO  MODO ESCURO  MODO ESCURO -->
<script>
    var clique = 1;

    // Mudando a frase ao clicar 
    function ModoClaro() {
        if (clique >= 10) {
            clique = 0;
        }
        if (clique % 2 == 1) {
            ModoEscuro.innerHTML = 'Modo Claro'
            clique += 1;

        } else {
            ModoEscuro.innerHTML = 'Modo Escuro'
            clique += 1;
        }
    }

    const body = document.querySelector("body");
    const modoEscuro = body.querySelector(".Modo");

    modoEscuro.addEventListener("click", () => {
        body.classList.toggle("Escuro");
    });
</script>

<script>
    var adicionar = 0;
    function Adicionar() {
        if (adicionar == 0) {
            adicionar3.classList = 'adicionar4'
            adicionar++;
            adicionar2.innerHTML = `                   
             <a href="#" >

<!--Imagem do ICONE DE ADICIONAR -->
<span class="icone"> <i class="uil uil-plus"></i> </span>
<span class="titulo"> Adicionar</span>
<span class="icone2"><i class="uil uil-angle-up"></i></span>

</a>`

        } else {
            adicionar3.classList = 'adicionar'
            adicionar = 0

            adicionar2.innerHTML = `                   
             <a href="#" >

<!--Imagem do ICONE DE ADICIONAR -->
<span class="icone"> <i class="uil uil-plus"></i> </span>
<span class="titulo"> Adicionar</span>
<span class="icone2"><i class="uil uil-angle-down"></i></span>

</a>`
        }
    }
</script>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;

    window.onload = obterDadosGraficos();

    function obterDadosGraficos() {
        obterDadosGrafico(1)
        obterDadosGrafico(2)
        obterDadosGrafico(3)
        obterDadosGrafico(4)
    }

    function alterarTitulo(idArmazem) {
        var tituloAquario = document.getElementById(`tituloAquario${idArmazem}`)
    }

    function exibirAquario(idArmazem) {
        let todosOsGraficos = document.getElementById("graficos")

        for (i = 1; i <= todosOsGraficos.childElementCount; i++) {
            // exibindo - ou não - o gráfico
            let elementoAtual = document.getElementById(`grafico${i}`)
            if (elementoAtual.classList.contains("display-block")) {
                elementoAtual.classList.remove("display-block")
            }
            elementoAtual.classList.add("display-none")

            // alterando estilo do botão
            let btnAtual = document.getElementById(`btnAquario${i}`)
            if (btnAtual.classList.contains("btn-pink")) {
                btnAtual.classList.remove("btn-pink")
            }
            btnAtual.classList.add("btn-white")
        }

        // exibindo - ou não - o gráfico
        let graficoExibir = document.getElementById(`grafico${idArmazem}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")

        // alterando estilo do botão
        let btnExibir = document.getElementById(`btnAquario${idArmazem}`)
        btnExibir.classList.remove("btn-white")
        btnExibir.classList.add("btn-pink")
    }
        
    function obterDadosGrafico(idArmazem) {

        alterarTitulo(idArmazem)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idArmazem}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    
                    plotarGrafico(resposta, idArmazem);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idArmazem) {

        console.log('iniciando plotagem do gráfico...');

        let labels = [];
        let dados = {
            labels: labels,
            datasets: [{
                data: [],
                label: 'Umidade',
                backgroundColor: 'rgba(0,0,240)',
                borderColor: 'rgba(168,217,254,1)',
                tension: 0.31
            }, {
                label: 'Temperatura',
                data: [],
                fill: false,
                backgroundColor: 'rgba(240,0,0)',
                borderColor: 'rgba(239,203,198,1)',
                tension: 0.3,
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        console.log("ISSO É O RESPOSTA.UMIDADE")
        console.log(resposta.temperatura)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.temperatura);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        const config = {
            type: 'line',
            data: dados,
        };

        let myChart2 = new Chart(
            document.getElementById(`myChartCanvas`),
            config
        );

        setTimeout(() => atualizarGrafico(idArmazem, dados, myChart2), 2000);
    }

    var temp_fora_ideal = 0;
    var umidade_fora_ideal = 0;

    function atualizarGrafico(idArmazem, dados, myChart2) {

        fetch(`/medidas/tempo-real/${idArmazem}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);     
                   
                    if(novoRegistro[0].temperatura > 16){
                        temp_fora_ideal+= 1
                        span_temperatura.innerHTML = temp_fora_ideal 
                    }
                    if(novoRegistro[0].umidade > 13){
                        umidade_fora_ideal +=1
                        span_umidade.innerHTML = umidade_fora_ideal
                    }
                    
                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].momento_grafico)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart2.update();
                    }

                    var opts_temperatura = {
                        angle: 0,
                        lineWidth: 0.4,
                        radiusScale: 1,
                        pointer: {
                            length: 0.5,
                            strokeWidth: 0.035,
                            color: '#d62828'

                        },
                        staticLabels: {
                            font: "10px sans-serif",
                            labels: [-3, 16, 21, 45],
                        },

                        limitMax: false,
                        limitMin: false,
                        strokeColor: '#EEEEEE',
                        generateGradient: true,
                        highDpiSupport: true,
                        staticZones: [
                            { strokeStyle: "#a7c957", min: -3, max: 16 },
                            { strokeStyle: "#ffb703", min: 16, max: 21 },
                            { strokeStyle: "#d62828", min: 21, max: 45 },
                        ],
                    };
                    var target_temperatura = document.getElementById('gauge-temperatura');
                    var gauge_temperatura = new Gauge(target_temperatura).setOptions(opts_temperatura);

                    gauge_temperatura.maxValue = 45;
                    gauge_temperatura.setMinValue(-3);
                    gauge_temperatura.animationSpeed = 5;
                    gauge_temperatura.set(novoRegistro[0].temperatura);
                    b_temperatura.innerHTML = novoRegistro[0].temperatura + "ºC"

                    var opts_umidade = {
                        angle: 0,
                        lineWidth: 0.4,
                        radiusScale: 1,
                        pointer: {
                            length: 0.5,
                            strokeWidth: 0.035,
                            color: '#054A29'
                        },
                        staticLabels: {
                            font: "10px sans-serif",
                            labels: [0, 13, 15, 17, 40],
                        },

                        limitMax: false,
                        limitMin: false,
                        strokeColor: '#EEEEEE',
                        generateGradient: true,
                        highDpiSupport: true,
                        staticZones: [
                            { strokeStyle: "#a7c957", min: 0, max: 13 },
                            { strokeStyle: "#ffb703", min: 13, max: 15 },
                            { strokeStyle: "#fb8500", min: 15, max: 17 },
                            { strokeStyle: "#d62828", min: 17, max: 40 },
                        ],
                    };
                    var target_umidade = document.getElementById('gauge-umidade');
                    var gauge_umidade = new Gauge(target_umidade).setOptions(opts_umidade);

                    console.log(novoRegistro[0])

                    gauge_umidade.maxValue = 40;
                    gauge_umidade.setMinValue(0);
                    gauge_umidade.animationSpeed = 5;
                    gauge_umidade.set(novoRegistro[0].umidade);
                    b_umidade.innerHTML = novoRegistro[0].umidade + "%"

                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idArmazem, dados, myChart2), 10000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idArmazem, dados, myChart2), 10000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
</script>